// schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id          String       @id @default(cuid())
  name        String
  email       String       @unique
  password    String
  role        UserRole     @default(COLABORADOR) // role global
  memberships Membership[] // relação N:N via Membership
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime? // soft delete
  companies   Company[] // relação 1:N
  sentInvites Invite[]     @relation("InviterInvites")
  projects    Project[]
  createdProcesses Process[] @relation("CreatedProcesses")
  ownedSteps ProcessStep[] @relation("OwnedSteps")
  reviews ProcessReview[] @relation("UserReviews")
}

model Company {
  id                  String                       @id @default(cuid())
  name                String
  description         String?
  type                CompanyType
  invites             Invite[]
  memberships         Membership[] // relação N:N via Membership
  createdAt           DateTime                     @default(now())
  updatedAt           DateTime                     @updatedAt
  deletedAt           DateTime? // soft delete
  ownerId             String
  owner               User                         @relation(fields: [ownerId], references: [id])
  projects            Project[]
  departments         Department[] // novo: relação 1:N com Department
  whatsappPermissions WhatsappInstancePermission[] // back-relation to permissions
}

model Membership {
  id        String  @id @default(cuid())
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  company   Company @relation(fields: [companyId], references: [id])
  companyId String

  role CompanyRole @default(COLABORADOR)

  active Boolean @default(true) // alinhado ao migration e aos tipos

  // novo: associação opcional a departamento
  department          Department?                  @relation(fields: [departmentId], references: [id])
  departmentId        String?
  whatsappPermissions WhatsappInstancePermission[] // back-relation to permissions

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  @@unique([userId, companyId]) // garante que não duplique associação
}

model Invite {
  id        String   @id @default(uuid())
  inviterId String
  companyId String
  token     String   @unique
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])
  inviter User    @relation("InviterInvites", fields: [inviterId], references: [id])
}

enum UserRole {
  ADMIN_GLOBAL
  GESTOR
  COLABORADOR
}

enum CompanyRole {
  ADMIN_EMPRESA
  GESTOR
  COLABORADOR
}

enum CompanyType {
  SOFTWARE // Vale AI
  MARKETING // Hub360
}

// novo: alvo da permissão de WhatsApp
enum WhatsappPermissionTarget {
  MEMBERSHIP
  DEPARTMENT
}

model Project {
  id               String       @id @default(cuid())
  companyId        String?
  company          Company?     @relation(fields: [companyId], references: [id])
  title            String
  description      String?
  clientName       String
  clientEmail      String?
  clientPhone      String?
  stage            ProjectStage @default(OPORTUNIDADE)
  probability      Int?
  budgetEstimate   Float?
  timelineEstimate Int?
  createdById      String
  createdBy        User         @relation(fields: [createdById], references: [id])
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?
  meetings         String[]
  artifacts        String[]
  approvals        String[]
}

// novo: modelo Department
model Department {
  id                  String                       @id @default(cuid())
  name                String
  companyId           String
  company             Company                      @relation(fields: [companyId], references: [id])
  memberships         Membership[]
  createdAt           DateTime                     @default(now())
  updatedAt           DateTime                     @updatedAt
  deletedAt           DateTime?
  whatsappPermissions WhatsappInstancePermission[] // back-relation to permissions
}

// novo: associação de instância de WhatsApp a membro ou departamento de uma empresa
model WhatsappInstancePermission {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  instanceId   String // id da instância (Evolution API)
  instanceName String?

  targetType   WhatsappPermissionTarget
  membershipId String?
  membership   Membership?              @relation(fields: [membershipId], references: [id])
  departmentId String?
  department   Department?              @relation(fields: [departmentId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([instanceId, companyId])
}

enum ProjectStage {
  OPORTUNIDADE
  LEAD
  BRIEFING1
  BRIEFING2
  DISCOVERY
  PROPOSTA
  CONTRATO
  EXECUCAO
  ENCERRADO
}

model Process {
  id            String        @id @default(cuid()) // Identificador único do processo
  createdById   String        // Usuário que criou o processo
  createdBy     User          @relation("CreatedProcesses", fields: [createdById], references: [id])

  name          String        // Nome do processo
  code          String        @unique // Código/ID único do processo
  description   String?       // Descrição geral do processo
  department    String        // Área ou departamento responsável
  objective     String?       // Objetivo do processo
  scopeInclude  String?       // Escopo: o que está incluído
  scopeExclude  String?       // Escopo: o que está excluído
  trigger       String?       // Gatilho que inicia o processo
  inputs        String[]      // Entradas necessárias para execução
  outputs       String[]      // Saídas esperadas do processo
  resources     String[]      // Recursos necessários para execução
  stage         ProcessStage  @default(DRAFT) // Estado do processo no ciclo de vida

  steps         ProcessStep[] // Passos/atividades do processo
  kpis          ProcessKPI[]  // KPIs e métricas do processo
  rules         ProcessRule[] // Regras, exceções e riscos do processo
  reviews       ProcessReview[] // Histórico de revisões/aprovações

  createdAt     DateTime      @default(now()) // Data de criação
  updatedAt     DateTime      @updatedAt      // Última atualização
  deletedAt     DateTime?     // Data de exclusão lógica (soft delete)
}

model ProcessStep {
  id            String   @id @default(cuid()) // Identificador único do passo
  processId     String   // Referência ao processo
  process       Process  @relation(fields: [processId], references: [id])
  order         Int      // Ordem sequencial do passo
  title         String   // Nome ou título da atividade
  description   String?  // Descrição detalhada da atividade
  ownerId       String?  // Usuário responsável pela execução
  owner         User?    @relation("OwnedSteps", fields: [ownerId], references: [id])
  estimatedTime Int?     // Estimativa de tempo em minutos
  taskSteps     TaskStep[] // Relação 1:N com TaskStep
  documents Document[] // Relação 1:N com Document
}

model ProcessKPI {
  id          String   @id @default(cuid()) // Identificador único do KPI
  processId   String   // Referência ao processo
  process     Process  @relation(fields: [processId], references: [id])
  name        String   // Nome do indicador (ex: tempo médio, custo)
  value       Float?   // Valor atual do indicador
  unit        String?  // Unidade de medida (ex: horas, R$, %)
}

model ProcessRule {
  id          String   @id @default(cuid()) // Identificador único da regra/risco
  processId   String   // Referência ao processo
  process     Process  @relation(fields: [processId], references: [id])
  type        RuleType // Tipo: regra de negócio, exceção ou risco
  description String   // Descrição da regra ou risco
  mitigation  String?  // Plano de mitigação/controle (se aplicável)
}

enum RuleType {
  BUSINESS_RULE  // Regras de negócio
  EXCEPTION      // Exceções conhecidas
  RISK           // Riscos potenciais
}

model TaskStep {
  id          String      @id @default(cuid()) // Identificador único da tarefa do passo
  stepId      String      // FK para ProcessStep
  step        ProcessStep @relation(fields: [stepId], references: [id])
  title       String      // Título da tarefa
  description String?     // Descrição da tarefa
  status      String?     // Status da tarefa (ex: PENDENTE, CONCLUÍDO)
  documents   Document[]  // Documentos relacionados à TaskStep
}

model Document {
  id          String      @id @default(cuid()) // Identificador único do documento
  stepId      String?     // FK para ProcessStep
  step        ProcessStep? @relation(fields: [stepId], references: [id])
  taskStepId  String?     // FK para TaskStep
  taskStep    TaskStep?   @relation(fields: [taskStepId], references: [id])
  title       String      // Título do documento
  type        String      // Tipo do documento (ex: PDF, LINK, IMAGEM)
  link        String?     // Link para o documento (se aplicável)
  description String?     // Descrição do documento
}

model ProcessReview {
  id          String       @id @default(cuid()) // Identificador único da revisão
  processId   String       // Referência ao processo
  process     Process      @relation(fields: [processId], references: [id])
  reviewerId  String       // Usuário responsável pela revisão
  reviewer    User         @relation("UserReviews", fields: [reviewerId], references: [id])
  status      ReviewStatus // Status da revisão
  comments    String?      // Observações do revisor
  createdAt   DateTime     @default(now()) // Data da revisão
}

enum ReviewStatus {
  PENDING   // Revisão pendente
  APPROVED  // Processo aprovado
  REJECTED  // Processo rejeitado
}

enum ProcessStage {
  DRAFT        // Rascunho inicial
  UNDER_REVIEW // Em revisão
  APPROVED     // Aprovado
  PUBLISHED    // Publicado
}

